# Optimized configuration for 16GB RAM, 6 vCPU server
# Use this for "maximum performance" benchmark
# Target location: /etc/postgresql/16/main/postgresql.conf

#------------------------------------------------------------------------------
# BENCHMARK SETTINGS - TUNED (16GB RAM / 6 vCPU)
#------------------------------------------------------------------------------

#------------------------------------------------------------------------------
# CONNECTIONS AND AUTHENTICATION
#------------------------------------------------------------------------------
max_connections = 300                    # Handle high concurrent load
superuser_reserved_connections = 3       # Reserve for admin

#------------------------------------------------------------------------------
# RESOURCE USAGE (Memory)
#------------------------------------------------------------------------------
shared_buffers = 4GB                     # 25% of RAM (main PostgreSQL cache)
huge_pages = try                         # Use huge pages if available
temp_buffers = 16MB                      # Per-session temp buffer
work_mem = 32MB                          # Per-operation sort/hash memory
                                         # (16GB - 4GB) / (300 × 3) ≈ 13MB, set to 32MB
maintenance_work_mem = 1GB               # For VACUUM, CREATE INDEX, etc.
autovacuum_work_mem = 512MB              # Per autovacuum worker

#------------------------------------------------------------------------------
# RESOURCE USAGE (Disk)
#------------------------------------------------------------------------------
temp_file_limit = -1                     # Unlimited temp file space

#------------------------------------------------------------------------------
# WRITE-AHEAD LOG
#------------------------------------------------------------------------------
wal_buffers = 16MB                       # WAL buffer size
wal_writer_delay = 200ms                 # WAL writer sleep time
checkpoint_timeout = 15min               # Time between checkpoints
checkpoint_completion_target = 0.9       # Spread checkpoint I/O over 90% of interval
max_wal_size = 4GB                       # Maximum WAL size between checkpoints
min_wal_size = 1GB                       # Minimum WAL size

#------------------------------------------------------------------------------
# QUERY TUNING
#------------------------------------------------------------------------------
# Planner Cost Constants
random_page_cost = 1.1                   # For SSD (1.1), for HDD use 4.0
effective_cache_size = 12GB              # 75% of RAM - OS + PostgreSQL cache estimate
default_statistics_target = 100          # Statistics detail level
cpu_tuple_cost = 0.01                    # Cost of processing each row
cpu_index_tuple_cost = 0.005             # Cost of processing index entry
cpu_operator_cost = 0.0025               # Cost of operator/function

# Planner Method Configuration
enable_partitionwise_join = on           # Parallel partition joins
enable_partitionwise_aggregate = on      # Parallel partition aggregates

#------------------------------------------------------------------------------
# PARALLELISM
#------------------------------------------------------------------------------
max_worker_processes = 6                 # Match vCPU count
max_parallel_workers_per_gather = 3      # 50% of vCPUs
max_parallel_maintenance_workers = 3     # For CREATE INDEX, VACUUM
max_parallel_workers = 6                 # Total parallel workers
parallel_leader_participation = on       # Leader participates in parallel query

#------------------------------------------------------------------------------
# BACKGROUND WRITER
#------------------------------------------------------------------------------
bgwriter_delay = 200ms                   # Background writer sleep time
bgwriter_lru_maxpages = 100              # Max pages to write per round
bgwriter_lru_multiplier = 2.0            # Multiplier for next round

#------------------------------------------------------------------------------
# ASYNCHRONOUS BEHAVIOR
#------------------------------------------------------------------------------
effective_io_concurrency = 200           # For SSDs (1-1000), for HDD use 2-4
maintenance_io_concurrency = 100         # For maintenance operations
max_wal_senders = 0                      # Disable replication (not needed for benchmark)
wal_level = minimal                      # Minimal WAL for performance

#------------------------------------------------------------------------------
# AUTOVACUUM
#------------------------------------------------------------------------------
autovacuum = on                          # Enable autovacuum
autovacuum_max_workers = 3               # Max autovacuum workers
autovacuum_naptime = 1min                # Time between autovacuum runs
autovacuum_vacuum_threshold = 50         # Min updates before vacuum
autovacuum_analyze_threshold = 50        # Min updates before analyze
autovacuum_vacuum_scale_factor = 0.1     # Fraction of table size
autovacuum_analyze_scale_factor = 0.05   # Fraction for analyze

#------------------------------------------------------------------------------
# CLIENT CONNECTION DEFAULTS
#------------------------------------------------------------------------------
# Statement Behavior
synchronous_commit = off                 # ⚠️ BENCHMARK ONLY - Trades durability for speed
                                         # DO NOT USE IN PRODUCTION
commit_delay = 0                         # No commit delay
commit_siblings = 5                      # Concurrent transactions for delay

# Locale and Formatting
datestyle = 'iso, mdy'
timezone = 'UTC'
lc_messages = 'en_US.UTF-8'
lc_monetary = 'en_US.UTF-8'
lc_numeric = 'en_US.UTF-8'
lc_time = 'en_US.UTF-8'
default_text_search_config = 'pg_catalog.english'

#------------------------------------------------------------------------------
# LOGGING (Minimal for performance)
#------------------------------------------------------------------------------
logging_collector = off                  # Disable log collection for max performance
log_min_messages = warning               # Only log warnings and errors
log_min_error_statement = error          # Only log error statements
log_duration = off                       # Don't log statement duration
log_statement = 'none'                   # Don't log statements
log_line_prefix = '%m [%p] '             # Minimal log prefix

#------------------------------------------------------------------------------
# LOCK MANAGEMENT
#------------------------------------------------------------------------------
deadlock_timeout = 1s                    # Time to wait before checking deadlock
max_locks_per_transaction = 64           # Default is fine
max_pred_locks_per_transaction = 64      # For serializable transactions